---
import ArticleLayout from '../../layouts/ArticleLayout.astro';
import LoveNote from '../../components/LoveNote.astro';
import { getArticle, getArticlesByLangPair, getAlternatesByTopicId } from '../../lib/blog-api';
import { sanitizeArticleContent } from '../../lib/sanitize-content';
import { splitContentAtMidpoint } from '../../lib/split-content';

// Language config for flags and names
const LANGUAGE_INFO: Record<string, { flag: string; name: string; nativeName: string }> = {
  en: { flag: 'ğŸ‡¬ğŸ‡§', name: 'English', nativeName: 'English' },
  es: { flag: 'ğŸ‡ªğŸ‡¸', name: 'Spanish', nativeName: 'EspaÃ±ol' },
  fr: { flag: 'ğŸ‡«ğŸ‡·', name: 'French', nativeName: 'FranÃ§ais' },
  it: { flag: 'ğŸ‡®ğŸ‡¹', name: 'Italian', nativeName: 'Italiano' },
  pt: { flag: 'ğŸ‡µğŸ‡¹', name: 'Portuguese', nativeName: 'PortuguÃªs' },
  ro: { flag: 'ğŸ‡·ğŸ‡´', name: 'Romanian', nativeName: 'RomÃ¢nÄƒ' },
  de: { flag: 'ğŸ‡©ğŸ‡ª', name: 'German', nativeName: 'Deutsch' },
  nl: { flag: 'ğŸ‡³ğŸ‡±', name: 'Dutch', nativeName: 'Nederlands' },
  sv: { flag: 'ğŸ‡¸ğŸ‡ª', name: 'Swedish', nativeName: 'Svenska' },
  no: { flag: 'ğŸ‡³ğŸ‡´', name: 'Norwegian', nativeName: 'Norsk' },
  da: { flag: 'ğŸ‡©ğŸ‡°', name: 'Danish', nativeName: 'Dansk' },
  pl: { flag: 'ğŸ‡µğŸ‡±', name: 'Polish', nativeName: 'Polski' },
  cs: { flag: 'ğŸ‡¨ğŸ‡¿', name: 'Czech', nativeName: 'ÄŒeÅ¡tina' },
  ru: { flag: 'ğŸ‡·ğŸ‡º', name: 'Russian', nativeName: 'Ğ ÑƒÑÑĞºĞ¸Ğ¹' },
  uk: { flag: 'ğŸ‡ºğŸ‡¦', name: 'Ukrainian', nativeName: 'Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°' },
  el: { flag: 'ğŸ‡¬ğŸ‡·', name: 'Greek', nativeName: 'Î•Î»Î»Î·Î½Î¹ÎºÎ¬' },
  hu: { flag: 'ğŸ‡­ğŸ‡º', name: 'Hungarian', nativeName: 'Magyar' },
  tr: { flag: 'ğŸ‡¹ğŸ‡·', name: 'Turkish', nativeName: 'TÃ¼rkÃ§e' },
};

// Parse slug: nativeLang/targetLang/article-slug
const { slug } = Astro.params;
const slugParts = (slug || '').split('/');

if (slugParts.length < 3) {
  return new Response(null, { status: 404, statusText: 'Not Found' });
}

const nativeLanguageCode = slugParts[0];
const targetLanguageCode = slugParts[1];
const articleSlug = slugParts.slice(2).join('/');

// Validate language codes â€” only real languages, not 'all'
const VALID_LANGS = Object.keys(LANGUAGE_INFO);
if (!VALID_LANGS.includes(nativeLanguageCode) || !VALID_LANGS.includes(targetLanguageCode)) {
  // Redirect methodology articles (target_lang='all') to their correct URL
  if (targetLanguageCode === 'all' && VALID_LANGS.includes(nativeLanguageCode)) {
    return Astro.redirect(`/learn/${nativeLanguageCode}/couples-language-learning/methodology/${articleSlug}/`, 301);
  }
  return new Response(null, { status: 404, statusText: 'Not Found' });
}

// Fetch article from Supabase
const article = await getArticle(nativeLanguageCode, targetLanguageCode, articleSlug);

if (!article) {
  return new Response(null, { status: 404, statusText: 'Not Found' });
}

// Non-canonical articles will be deleted rather than redirected.
// If is_canonical is ever set to false without deletion, serve as-is (no redirect).

const nativeLanguageInfo = LANGUAGE_INFO[nativeLanguageCode] || LANGUAGE_INFO.en;
const languageInfo = LANGUAGE_INFO[targetLanguageCode] || LANGUAGE_INFO.pl;
const languageCode = targetLanguageCode;

// Get related articles from same language pair
const allLangPairArticles = await getArticlesByLangPair(nativeLanguageCode, targetLanguageCode, { limit: 50 });

// Related: same category first
const relatedArticles = allLangPairArticles
  .filter(a => a.slug !== articleSlug && a.category === article.category)
  .slice(0, 3);

// Fill with other articles if needed
if (relatedArticles.length < 3) {
  const others = allLangPairArticles
    .filter(a => a.slug !== articleSlug && !relatedArticles.find(r => r.slug === a.slug))
    .slice(0, 3 - relatedArticles.length);
  relatedArticles.push(...others);
}

// Convert to format expected by layout
const relatedForLayout = relatedArticles.map(a => ({
  slug: `${a.native_lang}/${a.target_lang}/${a.slug}`,
  data: {
    title: a.title,
    description: a.description,
    category: a.category,
    difficulty: a.difficulty,
    readTime: a.read_time,
    image: a.image,
    tags: a.tags || [],
    date: a.date
  }
}));

// Find alternate versions (same topic in different native languages) via topic_id
const alternates = await getAlternatesByTopicId(
  article.topic_id,
  targetLanguageCode,
  nativeLanguageCode
);
const alternateVersions = alternates.map(a => ({
  nativeLang: a.native_lang,
  href: `https://www.lovelanguages.io/learn/${a.native_lang}/${targetLanguageCode}/${a.slug}/`
}));

// Cross-pair articles (simplified)
const crossPairArticles: any[] = [];

// Split content for mid-article LoveNote
const sanitizedContent = sanitizeArticleContent(article.content_html || article.content || '');
const { firstHalf, secondHalf } = splitContentAtMidpoint(sanitizedContent);
---

<ArticleLayout
  title={article.title}
  description={article.description}
  category={article.category}
  difficulty={article.difficulty}
  readTime={article.read_time}
  image={article.image}
  date={article.date}
  tags={article.tags || []}
  faqItems={article.faq_items}
  relatedArticles={relatedForLayout}
  languageCode={languageCode}
  languageInfo={languageInfo}
  nativeLanguageCode={nativeLanguageCode}
  nativeLanguageInfo={nativeLanguageInfo}
  alternateVersions={alternateVersions}
  reverseArticle={undefined}
  crossPairArticles={crossPairArticles}
  articleSlug={articleSlug}
>
  <Fragment set:html={firstHalf} />
  {secondHalf && (
    <LoveNote
      nativeLang={nativeLanguageCode}
      targetLang={targetLanguageCode}
      articleSlug={articleSlug}
    />
  )}
  <Fragment set:html={secondHalf} />
</ArticleLayout>
