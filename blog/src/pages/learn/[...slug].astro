---
import { getCollection } from 'astro:content';
import ArticleLayout from '../../layouts/ArticleLayout.astro';

// Language config for flags and names (subset of main app's LANGUAGE_CONFIGS)
const LANGUAGE_INFO: Record<string, { flag: string; name: string; nativeName: string }> = {
  en: { flag: 'ðŸ‡¬ðŸ‡§', name: 'English', nativeName: 'English' },
  es: { flag: 'ðŸ‡ªðŸ‡¸', name: 'Spanish', nativeName: 'EspaÃ±ol' },
  fr: { flag: 'ðŸ‡«ðŸ‡·', name: 'French', nativeName: 'FranÃ§ais' },
  it: { flag: 'ðŸ‡®ðŸ‡¹', name: 'Italian', nativeName: 'Italiano' },
  pt: { flag: 'ðŸ‡µðŸ‡¹', name: 'Portuguese', nativeName: 'PortuguÃªs' },
  ro: { flag: 'ðŸ‡·ðŸ‡´', name: 'Romanian', nativeName: 'RomÃ¢nÄƒ' },
  de: { flag: 'ðŸ‡©ðŸ‡ª', name: 'German', nativeName: 'Deutsch' },
  nl: { flag: 'ðŸ‡³ðŸ‡±', name: 'Dutch', nativeName: 'Nederlands' },
  sv: { flag: 'ðŸ‡¸ðŸ‡ª', name: 'Swedish', nativeName: 'Svenska' },
  no: { flag: 'ðŸ‡³ðŸ‡´', name: 'Norwegian', nativeName: 'Norsk' },
  da: { flag: 'ðŸ‡©ðŸ‡°', name: 'Danish', nativeName: 'Dansk' },
  pl: { flag: 'ðŸ‡µðŸ‡±', name: 'Polish', nativeName: 'Polski' },
  cs: { flag: 'ðŸ‡¨ðŸ‡¿', name: 'Czech', nativeName: 'ÄŒeÅ¡tina' },
  ru: { flag: 'ðŸ‡·ðŸ‡º', name: 'Russian', nativeName: 'Ð ÑƒÑÑÐºÐ¸Ð¹' },
  uk: { flag: 'ðŸ‡ºðŸ‡¦', name: 'Ukrainian', nativeName: 'Ð£ÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ°' },
  el: { flag: 'ðŸ‡¬ðŸ‡·', name: 'Greek', nativeName: 'Î•Î»Î»Î·Î½Î¹ÎºÎ¬' },
  hu: { flag: 'ðŸ‡­ðŸ‡º', name: 'Hungarian', nativeName: 'Magyar' },
  tr: { flag: 'ðŸ‡¹ðŸ‡·', name: 'Turkish', nativeName: 'TÃ¼rkÃ§e' },
};

export async function getStaticPaths() {
  const articles = await getCollection('articles');
  return articles.map((article) => ({
    params: { slug: article.slug },
    props: { article, allArticles: articles },
  }));
}

const { article, allArticles } = Astro.props;
const { Content } = await article.render();

// Extract languages from slug (e.g., "en/pl/article-name" -> nativeLang: "en", targetLang: "pl")
const slugParts = article.slug.split('/');
const nativeLanguageCode = slugParts[0] || 'en';
const targetLanguageCode = slugParts[1] || article.data.language || 'pl';
const languageCode = targetLanguageCode; // For backwards compatibility with layout

const nativeLanguageInfo = LANGUAGE_INFO[nativeLanguageCode] || LANGUAGE_INFO.en;
const languageInfo = LANGUAGE_INFO[targetLanguageCode] || LANGUAGE_INFO.pl;

// Get related articles: same native language, same target language, same category, excluding current, max 3
const relatedArticles = allArticles
  .filter((a) => {
    const aParts = a.slug.split('/');
    const aNativeLang = aParts[0];
    const aTargetLang = aParts[1];
    return a.slug !== article.slug &&
           aNativeLang === nativeLanguageCode &&
           aTargetLang === targetLanguageCode &&
           a.data.category === article.data.category;
  })
  .sort(() => Math.random() - 0.5)
  .slice(0, 3);

// If not enough in same category, fill with other articles from same native+target language pair
if (relatedArticles.length < 3) {
  const otherArticles = allArticles
    .filter((a) => {
      const aParts = a.slug.split('/');
      const aNativeLang = aParts[0];
      const aTargetLang = aParts[1];
      return a.slug !== article.slug &&
             aNativeLang === nativeLanguageCode &&
             aTargetLang === targetLanguageCode &&
             !relatedArticles.includes(a);
    })
    .sort(() => Math.random() - 0.5)
    .slice(0, 3 - relatedArticles.length);
  relatedArticles.push(...otherArticles);
}

// Find alternate versions of this article in other native languages
// E.g., if current is en/pl/article-name, find es/pl/article-name, fr/pl/article-name
const baseArticleSlug = slugParts.slice(2).join('/');
const alternateVersions = allArticles
  .filter((a) => {
    const aParts = a.slug.split('/');
    const aBaseSlug = aParts.slice(2).join('/');
    const aTargetLang = aParts[1];
    return aBaseSlug === baseArticleSlug &&
           aTargetLang === targetLanguageCode &&
           a.slug !== article.slug;
  })
  .map((altArticle) => {
    const altParts = altArticle.slug.split('/');
    return {
      nativeLang: altParts[0],
      href: `https://lovelanguages.xyz/learn/${altArticle.slug}/`
    };
  });
---

<ArticleLayout
  title={article.data.title}
  description={article.data.description}
  category={article.data.category}
  difficulty={article.data.difficulty}
  readTime={article.data.readTime}
  image={article.data.image}
  date={article.data.date}
  tags={article.data.tags}
  relatedArticles={relatedArticles}
  languageCode={languageCode}
  languageInfo={languageInfo}
  nativeLanguageCode={nativeLanguageCode}
  nativeLanguageInfo={nativeLanguageInfo}
  alternateVersions={alternateVersions}
>
  <Content />
</ArticleLayout>
