---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getArticlesByNativeLang, getArticleCountsByTargetLang, getTargetLanguages } from '../../../lib/blog-api';
import { LANGUAGE_HUB_DATA } from '../../../data/language-hub-data';
import { getUITranslations } from '../../../data/ui-translations';
import { LANGUAGES, getLanguageForDisplay, SUPPORTED_NATIVE_LANGS } from '../../../data/language-info';

const { nativeLang } = Astro.params;
const nativeLanguageCode = nativeLang || 'en';

// Validate native language
if (!SUPPORTED_NATIVE_LANGS.includes(nativeLanguageCode)) {
  return Astro.redirect('/learn/');
}

const nativeInfo = getLanguageForDisplay(nativeLanguageCode, nativeLanguageCode);

// Count articles per target language for this native language (single query)
const languageCounts = await getArticleCountsByTargetLang(nativeLanguageCode);

// Get all languages except native, with translated names
const sortedLanguageCodes = Object.keys(LANGUAGES)
  .filter(code => code !== nativeLanguageCode)
  .sort((codeA, codeB) => {
    const countA = languageCounts[codeA] || 0;
    const countB = languageCounts[codeB] || 0;
    if (countA > 0 && countB === 0) return -1;
    if (countB > 0 && countA === 0) return 1;
    // Sort by translated name in user's language
    const nameA = getLanguageForDisplay(codeA, nativeLanguageCode).name;
    const nameB = getLanguageForDisplay(codeB, nativeLanguageCode).name;
    return nameA.localeCompare(nameB);
  });

// Get total article count for this native language
const totalArticles = Object.values(languageCounts).reduce((sum, count) => sum + count, 0);

// Get language data with article counts for featured display (using translated names)
const allLanguages = sortedLanguageCodes.map(code => ({
  ...getLanguageForDisplay(code, nativeLanguageCode),
  articleCount: languageCounts[code] || 0,
  hubData: LANGUAGE_HUB_DATA[code]
}));

const featuredLanguages = allLanguages.filter(l => l.articleCount > 0).slice(0, 6);
const otherLanguages = allLanguages.filter(l => !featuredLanguages.find(f => f.code === l.code));

// Latest articles for this native language
const latestArticles = await getArticlesByNativeLang(nativeLanguageCode, { limit: 4 });

const getArticleUrl = (article: any) => `/learn/${article.native_lang}/${article.target_lang}/${article.slug}/`;
const getLangFromArticle = (article: any) => article.target_lang;

// Get translations for this native language
const text = getUITranslations(nativeLanguageCode);

// Hreflang alternates
const hreflangAlternates = SUPPORTED_NATIVE_LANGS
  .filter(lang => lang !== nativeLanguageCode)
  .map(lang => ({
    lang,
    href: `https://www.lovelanguages.io/learn/${lang}/`
  }));

const canonicalUrl = `https://www.lovelanguages.io/learn/${nativeLanguageCode}/`;
const xDefaultUrl = nativeLanguageCode === 'en' ? canonicalUrl : 'https://www.lovelanguages.io/learn/en/';

// JSON-LD
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": `Love Languages - ${text.heroTitle}`,
  "description": text.heroSubtitle,
  "url": canonicalUrl,
  "inLanguage": nativeLanguageCode,
  "publisher": {
    "@type": "Organization",
    "name": "Love Languages",
    "url": "https://www.lovelanguages.io"
  },
  "numberOfItems": totalArticles
};
---

<BaseLayout
  title={`${text.heroTitle} - Love Languages`}
  description={text.heroSubtitle}
  nativeLang={nativeLanguageCode}
>
  <Fragment slot="head">
    <link rel="canonical" href={canonicalUrl} />
    <link rel="alternate" hreflang={nativeLanguageCode} href={canonicalUrl} />
    <link rel="alternate" hreflang="x-default" href={xDefaultUrl} />
    {hreflangAlternates.map(alt => (
      <link rel="alternate" hreflang={alt.lang} href={alt.href} />
    ))}
  </Fragment>

  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

  <!-- Hero -->
  <header class="relative overflow-hidden" style="background: linear-gradient(135deg, #FFF0F3 0%, #fdfcfd 50%, #E7F5FF 100%);">
    <div class="max-w-6xl mx-auto px-4 py-16 md:py-24">
      <div class="grid md:grid-cols-2 gap-8 items-center">
        <div>
          <p class="text-[#FF6B6B] font-medium mb-3 tracking-wide uppercase text-sm">{text.heroTagline}</p>
          <h1 class="text-4xl md:text-6xl font-black font-header text-[#292F36] mb-6 leading-tight">
            {text.heroTitle}
          </h1>
          <p class="text-xl text-gray-600 mb-8 leading-relaxed">
            {text.heroSubtitle}
          </p>
          <div class="flex flex-wrap gap-4 mb-8">
            <a href="#languages" class="inline-flex items-center gap-2 px-6 py-3 rounded-full font-bold text-white transition-all hover:scale-105 hover:shadow-lg" style="background: linear-gradient(135deg, #FF6B6B, #FF8E8E);">
              {text.browseLanguages}
            </a>
            <a href={`/learn/${nativeLanguageCode}/couples-language-learning/`} class="inline-flex items-center gap-2 px-6 py-3 rounded-full font-bold transition-all hover:scale-105" style="color: #4ECDC4; border: 2px solid #4ECDC4;">
              {text.whyLearnTogether}
            </a>
          </div>
          <div class="flex gap-6 text-sm">
            <div><span class="font-bold text-[#292F36] text-lg">{totalArticles}+</span> <span class="text-gray-500">{text.articles}</span></div>
            <div><span class="font-bold text-[#292F36] text-lg">17</span> <span class="text-gray-500">{text.languages}</span></div>
          </div>
        </div>

        <!-- Flag cluster -->
        <div class="hidden md:flex justify-center items-center relative h-64">
          <div class="absolute inset-0 flex items-center justify-center">
            <div class="relative">
              {allLanguages.slice(0, 8).map((lang, i) => {
                const positions = [
                  { x: 0, y: -60, rotate: -5, scale: 1.4 },
                  { x: 70, y: -30, rotate: 8, scale: 1.2 },
                  { x: 85, y: 40, rotate: -3, scale: 1.1 },
                  { x: 30, y: 70, rotate: 10, scale: 1 },
                  { x: -50, y: 60, rotate: -8, scale: 1.1 },
                  { x: -80, y: 10, rotate: 5, scale: 1.2 },
                  { x: -60, y: -45, rotate: -10, scale: 1 },
                  { x: 10, y: 10, rotate: 0, scale: 1.6 },
                ];
                const pos = positions[i];
                return (
                  <span
                    class="absolute text-4xl transition-transform hover:scale-125 cursor-default select-none"
                    style={`transform: translate(${pos.x}px, ${pos.y}px) rotate(${pos.rotate}deg) scale(${pos.scale}); filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));`}
                  >
                    {lang.flag}
                  </span>
                );
              })}
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Languages Section -->
  <section id="languages" class="py-16 bg-white">
    <div class="max-w-6xl mx-auto px-4">
      <div class="text-center mb-12">
        <h2 class="text-3xl font-bold font-header text-[#292F36] mb-3">{text.chooseLanguage}</h2>
        <p class="text-gray-600">{text.chooseLanguageSubtitle}</p>
      </div>

      <!-- Featured languages -->
      {featuredLanguages.length > 0 && (
        <div class="grid md:grid-cols-3 gap-6 mb-10">
          {featuredLanguages.map((lang, i) => (
            <a
              href={`/learn/${nativeLanguageCode}/${lang.code}/`}
              class="group relative p-6 rounded-2xl transition-all hover:shadow-2xl hover:-translate-y-1 overflow-hidden"
              style={`background: ${i === 0 ? 'linear-gradient(135deg, #FFF0F3 0%, white 100%)' : i === 1 ? 'linear-gradient(135deg, #E7F5FF 0%, white 100%)' : 'linear-gradient(135deg, #F0FDF4 0%, white 100%)'};`}
            >
              <div class="relative">
                <span class="text-5xl mb-4 block group-hover:scale-110 transition-transform origin-left">{lang.flag}</span>
                <h3 class="text-2xl font-bold text-[#292F36] mb-1 group-hover:text-[#FF6B6B] transition-colors">{lang.name}</h3>
                <p class="text-gray-500 text-sm mb-4">{lang.nativeName}</p>
                <div class="flex gap-4 mb-4 text-sm">
                  <div>
                    <span class="font-bold text-[#292F36]">{lang.articleCount}</span>
                    <span class="text-gray-500 ml-1">{text.guides}</span>
                  </div>
                  {lang.hubData && (
                    <>
                      <div>
                        <span class="font-bold text-[#292F36]">{lang.hubData.fsiHours}h</span>
                        <span class="text-gray-500 ml-1">{text.toFluency}</span>
                      </div>
                    </>
                  )}
                </div>
              </div>
            </a>
          ))}
        </div>
      )}

      <!-- All Languages -->
      <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-11 gap-3">
        {otherLanguages.map(lang => (
          <a
            href={`/learn/${nativeLanguageCode}/${lang.code}/`}
            class="group flex flex-col items-center p-3 rounded-xl border border-gray-100 hover:border-[#FF6B6B] hover:shadow-md transition-all bg-white"
          >
            <span class="text-2xl mb-1 group-hover:scale-110 transition-transform">{lang.flag}</span>
            <span class="text-xs font-medium text-gray-700 group-hover:text-[#FF6B6B] text-center">{lang.name}</span>
            {lang.articleCount > 0 && (
              <span class="text-[10px] text-gray-400">{lang.articleCount}</span>
            )}
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- Latest Articles -->
  {latestArticles.length > 0 && (
    <section class="py-16" style="background: #fdfcfd;">
      <div class="max-w-6xl mx-auto px-4">
        <div class="flex items-center justify-between mb-8">
          <div>
            <h2 class="text-2xl font-bold font-header text-[#292F36]">{text.freshReads}</h2>
            <p class="text-gray-600 text-sm">{text.latestGuides}</p>
          </div>
        </div>

        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
          {latestArticles.map(article => {
            const langCode = getLangFromArticle(article);
            const langData = LANGUAGE_HUB_DATA[langCode];
            return (
              <a href={getArticleUrl(article)} class="group block">
                <div class="p-5 rounded-2xl border border-gray-100 bg-white hover:shadow-lg hover:border-[#4ECDC4] transition-all h-full">
                  <div class="flex items-center gap-2 mb-3">
                    <span class="text-lg">{langData?.flag}</span>
                    <span class="text-xs font-medium px-2 py-0.5 rounded-full" style="background: #E7F5FF; color: #4ECDC4;">{langData?.name}</span>
                  </div>
                  <h3 class="font-bold text-[#292F36] group-hover:text-[#4ECDC4] transition-colors mb-2 line-clamp-2 text-sm">
                    {article.title}
                  </h3>
                  <p class="text-xs text-gray-500 line-clamp-2">{article.description}</p>
                </div>
              </a>
            );
          })}
        </div>
      </div>
    </section>
  )}

  <!-- Couples CTA -->
  <section class="py-16 bg-white">
    <div class="max-w-4xl mx-auto px-4">
      <div class="relative rounded-3xl p-8 md:p-12 overflow-hidden" style="background: linear-gradient(135deg, #FFF0F3 0%, #E7F5FF 100%);">
        <div class="relative text-center">
          <div class="inline-flex items-center gap-3 mb-6">
            <span class="text-5xl">üë©‚Äç‚ù§Ô∏è‚Äçüë®</span>
          </div>
          <h2 class="text-3xl md:text-4xl font-bold font-header text-[#292F36] mb-4">
            {text.betterTogether}
          </h2>
          <p class="text-gray-600 mb-8 max-w-xl mx-auto text-lg">
            {text.couplesMotivation}
          </p>
          <a
            href={`/learn/${nativeLanguageCode}/couples-language-learning/`}
            class="inline-flex items-center gap-2 px-8 py-4 rounded-full font-bold text-white transition-all hover:scale-105 hover:shadow-xl"
            style="background: linear-gradient(135deg, #FF6B6B, #FF8E8E);"
          >
            {text.discoverCouples}
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- App CTA -->
  <section class="py-20" style="background: linear-gradient(135deg, #FF6B6B 0%, #FF8E8E 50%, #FFB4B4 100%);">
    <div class="max-w-2xl mx-auto px-4 text-center text-white">
      <h2 class="text-3xl md:text-4xl font-bold font-header mb-4">
        {text.ctaTitle}
      </h2>
      <p class="text-white/90 mb-8 text-lg">
        {text.ctaSubtitle}
      </p>
      <a
        href="/"
        class="inline-block bg-white font-bold px-10 py-4 rounded-full hover:shadow-2xl hover:scale-105 transition-all text-lg"
        style="color: #FF6B6B;"
      >
        {text.ctaButton}
      </a>
      <p class="mt-6 text-white/70 text-sm">
        {text.freeToStart}
      </p>
    </div>
  </section>

  <!-- Footer -->
  <footer class="py-12 border-t" style="background: #fdfcfd; border-color: #f0f0f0;">
    <div class="max-w-6xl mx-auto px-4 text-center">
      <a href="/" class="inline-flex items-center gap-2 text-2xl font-bold font-header mb-4" style="color: #FF6B6B;">
        <img src="/favicon.svg" alt="" class="w-8 h-8" />
        Love Languages
      </a>
      <p class="text-gray-600 mb-6">{text.heroSubtitle}</p>
      <nav class="flex justify-center gap-6 text-sm text-gray-400">
        <a href={`/learn/${nativeLanguageCode}/`} class="hover:text-[#FF6B6B]">{text.blog}</a>
        <a href="/tools" class="hover:text-[#FF6B6B]">{text.tools}</a>
      </nav>
    </div>
  </footer>
</BaseLayout>
