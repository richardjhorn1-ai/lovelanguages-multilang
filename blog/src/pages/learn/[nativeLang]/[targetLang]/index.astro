---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import ArticleCard from '../../../../components/ArticleCard.astro';
import LanguageSelector from '../../../../components/LanguageSelector.astro';
import Testimonials from '../../../../components/Testimonials.astro';
import { getArticlesByLangPair, getArticleCountsByTargetLang } from '../../../../lib/blog-api';
import { getUITranslations, insertLanguage } from '../../../../data/ui-translations';
import { LANGUAGES, getLanguageForDisplay, getAllLanguagesForDisplay, SUPPORTED_NATIVE_LANGS } from '../../../../data/language-info';

const { nativeLang, targetLang } = Astro.params;
const nativeLanguageCode = nativeLang || 'en';
const targetLanguageCode = targetLang || 'pl';

// Validate languages
if (!LANGUAGES[nativeLanguageCode] || !LANGUAGES[targetLanguageCode]) {
  return Astro.redirect('/learn/');
}

if (nativeLanguageCode === targetLanguageCode) {
  return Astro.redirect('/learn/');
}

// Get language info with names translated to user's native language
const nativeInfo = getLanguageForDisplay(nativeLanguageCode, nativeLanguageCode);
const targetInfo = getLanguageForDisplay(targetLanguageCode, nativeLanguageCode);

// Build LANGUAGE_INFO for LanguageSelector component (with translated names)
const LANGUAGE_INFO = Object.fromEntries(
  Object.keys(LANGUAGES).map(code => [
    code,
    getLanguageForDisplay(code, nativeLanguageCode)
  ])
);

// Get translations for native language
const text = getUITranslations(nativeLanguageCode);

// Get articles for this language pair from Supabase
const articles = await getArticlesByLangPair(nativeLanguageCode, targetLanguageCode, { limit: 100 });

// Get article counts per target language (single query)
const languageCounts = await getArticleCountsByTargetLang(nativeLanguageCode);

// Category filters with translated labels
const categories = [
  { id: 'all', label: text.categoryAll, icon: 'ðŸ“–' },
  { id: 'phrases', label: text.categoryPhrases, icon: 'ðŸ’¬' },
  { id: 'vocabulary', label: text.categoryVocabulary, icon: 'ðŸ“š' },
  { id: 'grammar', label: text.categoryGrammar, icon: 'ðŸ“' },
  { id: 'culture', label: text.categoryCulture, icon: targetInfo.flag },
  { id: 'situations', label: text.categorySituations, icon: 'ðŸŽ­' },
];

// Hreflang alternates (SUPPORTED_NATIVE_LANGS imported from language-info.ts)
const hreflangAlternates = SUPPORTED_NATIVE_LANGS
  .filter(lang => lang !== nativeLanguageCode && lang !== targetLanguageCode)
  .map(lang => ({
    lang,
    href: `https://www.lovelanguages.io/learn/${lang}/${targetLanguageCode}/`
  }));

const canonicalUrl = `https://www.lovelanguages.io/learn/${nativeLanguageCode}/${targetLanguageCode}/`;
const xDefaultUrl = nativeLanguageCode === 'en' ? canonicalUrl : `https://www.lovelanguages.io/learn/en/${targetLanguageCode}/`;

// Page title and description using translations
const pageTitle = `${insertLanguage(text.learnTogether, targetInfo.name)} - Love Languages`;
const pageDescription = insertLanguage(text.lessonsDescription, targetInfo.name);

// JSON-LD
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "Blog",
  "name": `Love Languages - ${insertLanguage(text.learnTogether, targetInfo.name)}`,
  "description": pageDescription,
  "url": canonicalUrl,
  "inLanguage": nativeLanguageCode,
  "publisher": {
    "@type": "Organization",
    "name": "Love Languages",
    "url": "https://www.lovelanguages.io"
  }
};
---

<BaseLayout
  title={pageTitle}
  description={pageDescription}
  nativeLang={nativeLanguageCode}
  targetLang={targetLanguageCode}
>
  <Fragment slot="head">
    <link rel="canonical" href={canonicalUrl} />
    <link rel="alternate" hreflang={nativeLanguageCode} href={canonicalUrl} />
    <link rel="alternate" hreflang="x-default" href={xDefaultUrl} />
    {hreflangAlternates.map(alt => (
      <link rel="alternate" hreflang={alt.lang} href={alt.href} />
    ))}
  </Fragment>

  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

  <!-- Hero Section -->
  <header class="bg-gradient-to-b from-accent/10 to-white">
    <div class="max-w-6xl mx-auto px-4 py-6 md:py-8">
      <div class="text-center max-w-2xl mx-auto">
        <div class="mb-4">
          <LanguageSelector
            currentLang={targetLanguageCode}
            nativeLang={nativeLanguageCode}
            languageInfo={LANGUAGE_INFO}
            languageCounts={languageCounts}
          />
        </div>
        <h1 class="text-3xl md:text-4xl font-black font-header text-gray-900 mb-2">
          <span class="text-4xl md:text-5xl">{targetInfo.flag}</span> {insertLanguage(text.learnTogether, targetInfo.name)}
        </h1>
        <p class="text-lg text-gray-600">
          {insertLanguage(text.lessonsDescription, targetInfo.name)}
        </p>
      </div>
    </div>
  </header>

  <!-- Filter Bar -->
  <div class="sticky top-14 z-40 bg-white/90 backdrop-blur-lg border-b border-gray-100">
    <div class="max-w-6xl mx-auto px-4">
      <div class="flex gap-2 overflow-x-auto py-3 scrollbar-hide" id="filter-bar">
        {categories.map((cat, i) => (
          <button
            type="button"
            data-category={cat.id}
            class={`filter-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors cursor-pointer ${
              i === 0
                ? 'bg-accent text-white active'
                : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
            }`}
          >
            {cat.icon} {cat.label}
          </button>
        ))}
      </div>
    </div>
  </div>

  <!-- Article Grid -->
  <main class="max-w-6xl mx-auto px-4 py-8">
    {articles.length > 0 ? (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="article-grid">
        {articles.map((article) => (
          <div class="article-item" data-category={article.category}>
            <ArticleCard
              slug={`${article.native_lang}/${article.target_lang}/${article.slug}`}
              title={article.title}
              description={article.description || ''}
              category={article.category || 'general'}
              difficulty={article.difficulty || 'beginner'}
              readTime={article.read_time || 5}
              image={article.image || ''}
              date={article.date || new Date().toISOString()}
            />
          </div>
        ))}
      </div>
    ) : (
      <div class="text-center py-20">
        <div class="text-6xl mb-4">{targetInfo.flag}</div>
        <h2 class="text-2xl font-bold text-gray-900 mb-2">{insertLanguage(text.comingSoon, targetInfo.name)}</h2>
        <p class="text-gray-600 mb-6">{insertLanguage(text.comingSoonDescription, targetInfo.name)}</p>
        <a href={`/learn/${nativeLanguageCode}/`} class="inline-block bg-accent text-white font-bold px-6 py-3 rounded-full hover:bg-accent/90 transition-colors">
          {text.browseAllLanguages}
        </a>
      </div>
    )}
  </main>

  <!-- Testimonials -->
  <section class="max-w-6xl mx-auto px-4">
    <Testimonials />
  </section>

  <!-- Main CTA -->
  <section class="bg-gradient-to-r from-accent to-pink-500 py-16">
    <div class="max-w-2xl mx-auto px-4 text-center text-white">
      <h2 class="text-3xl font-bold font-header mb-4">
        {insertLanguage(text.readyToStart, targetInfo.name)}
      </h2>
      <p class="text-white/90 mb-8">
        {insertLanguage(text.joinCouples, targetInfo.name)}
      </p>
      <a
        href="/"
        class="inline-block bg-white text-accent font-bold px-8 py-4 rounded-full hover:shadow-lg hover:scale-105 transition-all text-lg"
      >
        {text.startJourney}
      </a>
    </div>
  </section>

  <!-- Footer -->
  <footer class="bg-gray-100 border-t border-gray-200 py-12">
    <div class="max-w-6xl mx-auto px-4 text-center">
      <a href="/" class="inline-flex items-center gap-2 text-2xl font-bold font-header text-accent mb-4">
        <img src="/favicon.svg" alt="" class="w-8 h-8" />
        Love Languages
      </a>
      <p class="text-gray-600 mb-6">{text.footerTagline}</p>
      <nav class="flex justify-center gap-6 text-sm text-gray-500">
        <a href={`/learn/${nativeLanguageCode}/`} class="hover:text-accent">{text.blog}</a>
        <a href="/tools" class="hover:text-accent">{text.tools}</a>
      </nav>
    </div>
  </footer>
</BaseLayout>

<style>
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  .article-item.hidden {
    display: none;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const filterButtons = document.querySelectorAll('.filter-btn');
    const articles = document.querySelectorAll('.article-item');

    filterButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const category = btn.getAttribute('data-category');

        filterButtons.forEach(b => {
          b.classList.remove('bg-accent', 'text-white', 'active');
          b.classList.add('bg-gray-100', 'text-gray-600');
        });
        btn.classList.remove('bg-gray-100', 'text-gray-600');
        btn.classList.add('bg-accent', 'text-white', 'active');

        articles.forEach(article => {
          const articleCategory = article.getAttribute('data-category');
          if (category === 'all' || articleCategory === category) {
            article.classList.remove('hidden');
          } else {
            article.classList.add('hidden');
          }
        });
      });
    });
  });
</script>
