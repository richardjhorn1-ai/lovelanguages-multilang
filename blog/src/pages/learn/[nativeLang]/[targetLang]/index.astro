---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import ArticleCard from '../../../../components/ArticleCard.astro';
import LanguageSelector from '../../../../components/LanguageSelector.astro';
import Testimonials from '../../../../components/Testimonials.astro';
import { getCollection } from 'astro:content';

// Language config for flags and names
const LANGUAGE_INFO: Record<string, { flag: string; name: string; nativeName: string }> = {
  en: { flag: 'ðŸ‡¬ðŸ‡§', name: 'English', nativeName: 'English' },
  es: { flag: 'ðŸ‡ªðŸ‡¸', name: 'Spanish', nativeName: 'EspaÃ±ol' },
  fr: { flag: 'ðŸ‡«ðŸ‡·', name: 'French', nativeName: 'FranÃ§ais' },
  it: { flag: 'ðŸ‡®ðŸ‡¹', name: 'Italian', nativeName: 'Italiano' },
  pt: { flag: 'ðŸ‡µðŸ‡¹', name: 'Portuguese', nativeName: 'PortuguÃªs' },
  ro: { flag: 'ðŸ‡·ðŸ‡´', name: 'Romanian', nativeName: 'RomÃ¢nÄƒ' },
  de: { flag: 'ðŸ‡©ðŸ‡ª', name: 'German', nativeName: 'Deutsch' },
  nl: { flag: 'ðŸ‡³ðŸ‡±', name: 'Dutch', nativeName: 'Nederlands' },
  sv: { flag: 'ðŸ‡¸ðŸ‡ª', name: 'Swedish', nativeName: 'Svenska' },
  no: { flag: 'ðŸ‡³ðŸ‡´', name: 'Norwegian', nativeName: 'Norsk' },
  da: { flag: 'ðŸ‡©ðŸ‡°', name: 'Danish', nativeName: 'Dansk' },
  pl: { flag: 'ðŸ‡µðŸ‡±', name: 'Polish', nativeName: 'Polski' },
  cs: { flag: 'ðŸ‡¨ðŸ‡¿', name: 'Czech', nativeName: 'ÄŒeÅ¡tina' },
  ru: { flag: 'ðŸ‡·ðŸ‡º', name: 'Russian', nativeName: 'Ð ÑƒÑÑÐºÐ¸Ð¹' },
  uk: { flag: 'ðŸ‡ºðŸ‡¦', name: 'Ukrainian', nativeName: 'Ð£ÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ°' },
  el: { flag: 'ðŸ‡¬ðŸ‡·', name: 'Greek', nativeName: 'Î•Î»Î»Î·Î½Î¹ÎºÎ¬' },
  hu: { flag: 'ðŸ‡­ðŸ‡º', name: 'Hungarian', nativeName: 'Magyar' },
  tr: { flag: 'ðŸ‡¹ðŸ‡·', name: 'Turkish', nativeName: 'TÃ¼rkÃ§e' },
};

const SUPPORTED_LANGUAGES = Object.keys(LANGUAGE_INFO);

// Generate static paths for all native/target language combinations
export async function getStaticPaths() {
  const paths: { params: { nativeLang: string; targetLang: string } }[] = [];

  // Native languages that have translated content
  const nativeLanguages = ['en', 'es', 'fr', 'de', 'it', 'pt', 'ru', 'pl', 'tr', 'nl', 'ro', 'uk']; // All 12 native languages with content
  const targetLanguages = ['en', 'es', 'fr', 'it', 'pt', 'ro', 'de', 'nl', 'sv', 'no', 'da', 'pl', 'cs', 'ru', 'uk', 'el', 'hu', 'tr'];

  for (const nativeLang of nativeLanguages) {
    for (const targetLang of targetLanguages) {
      // Don't create path for learning your own language
      if (nativeLang !== targetLang) {
        paths.push({ params: { nativeLang, targetLang } });
      }
    }
  }

  return paths;
}

const { nativeLang, targetLang } = Astro.params;
const nativeLanguageCode = nativeLang || 'en';
const targetLanguageCode = targetLang || 'pl';

const nativeInfo = LANGUAGE_INFO[nativeLanguageCode] || LANGUAGE_INFO.en;
const targetInfo = LANGUAGE_INFO[targetLanguageCode] || LANGUAGE_INFO.pl;

// Get all articles for this native/target language pair
const allArticles = await getCollection('articles');
const articles = allArticles
  .filter(a => a.slug.startsWith(`${nativeLanguageCode}/${targetLanguageCode}/`))
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

// Get article counts per target language (for the current native language)
const languageCounts: Record<string, number> = {};
for (const code of SUPPORTED_LANGUAGES) {
  if (code !== nativeLanguageCode) {
    languageCounts[code] = allArticles.filter(a => a.slug.startsWith(`${nativeLanguageCode}/${code}/`)).length;
  }
}

// Category filters
const categories = [
  { id: 'all', label: 'All', icon: 'ðŸ“–' },
  { id: 'phrases', label: 'Phrases', icon: 'ðŸ’¬' },
  { id: 'vocabulary', label: 'Vocabulary', icon: 'ðŸ“š' },
  { id: 'grammar', label: 'Grammar', icon: 'ðŸ“' },
  { id: 'culture', label: 'Culture', icon: targetInfo.flag },
  { id: 'situations', label: 'Situations', icon: 'ðŸŽ­' },
];

// Hreflang: Find equivalent hub pages for different native languages learning the same target
// E.g., /learn/en/pl/ links to /learn/es/pl/, /learn/fr/pl/, etc.
// Must include ALL native languages that have content
const SUPPORTED_NATIVE_LANGS = ['en', 'es', 'fr', 'de', 'it', 'pt', 'pl', 'nl', 'ro', 'ru', 'tr', 'uk'];
const hreflangAlternates = SUPPORTED_NATIVE_LANGS
  .filter(lang => lang !== nativeLanguageCode && lang !== targetLanguageCode)
  .map(lang => ({
    lang,
    href: `https://www.lovelanguages.io/learn/${lang}/${targetLanguageCode}/`
  }));

const canonicalUrl = `https://www.lovelanguages.io/learn/${nativeLanguageCode}/${targetLanguageCode}/`;
const xDefaultUrl = nativeLanguageCode === 'en' ? canonicalUrl : `https://www.lovelanguages.io/learn/en/${targetLanguageCode}/`;

// JSON-LD for the blog listing page
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "Blog",
  "name": `Love Languages - Learn ${targetInfo.name} Blog`,
  "description": `Free ${targetInfo.name} lessons, vocabulary guides, and cultural tips for couples learning together.`,
  "url": `https://www.lovelanguages.io/learn/${nativeLanguageCode}/${targetLanguageCode}/`,
  "inLanguage": nativeLanguageCode,
  "publisher": {
    "@type": "Organization",
    "name": "Love Languages",
    "url": "https://www.lovelanguages.io"
  },
  "blogPost": articles.map(article => ({
    "@type": "BlogPosting",
    "headline": article.data.title,
    "description": article.data.description,
    "url": `https://www.lovelanguages.io/learn/${article.slug}/`,
    "datePublished": article.data.date
  }))
};
---

<BaseLayout
  title={`Learn ${targetInfo.name} - Free Lessons for Couples`}
  description={`Free ${targetInfo.name} lessons, vocabulary guides, and cultural tips designed for couples learning together. Start your ${targetInfo.name} language journey today.`}
  nativeLang={nativeLanguageCode}
  targetLang={targetLanguageCode}
>
  <Fragment slot="head">
    {/* Hreflang tags for international SEO
        Links to equivalent pages for speakers of other languages learning the same target
    */}
    <link rel="canonical" href={canonicalUrl} />
    <link rel="alternate" hreflang={nativeLanguageCode} href={canonicalUrl} />
    <link rel="alternate" hreflang="x-default" href={xDefaultUrl} />
    {hreflangAlternates.map(alt => (
      <link rel="alternate" hreflang={alt.lang} href={alt.href} />
    ))}
  </Fragment>

  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

  <!-- Hero Section -->
  <header class="bg-gradient-to-b from-accent/10 to-white">
    <div class="max-w-6xl mx-auto px-4 py-6 md:py-8">
      <div class="text-center max-w-2xl mx-auto">
        <div class="mb-4">
          <LanguageSelector
            currentLang={targetLanguageCode}
            nativeLang={nativeLanguageCode}
            languageInfo={LANGUAGE_INFO}
            languageCounts={languageCounts}
          />
        </div>
        <h1 class="text-3xl md:text-4xl font-black font-header text-gray-900 mb-2">
          <span class="text-4xl md:text-5xl">{targetInfo.flag}</span> Learn {targetInfo.name} Together
        </h1>
        <p class="text-lg text-gray-600">
          Lessons, vocabulary guides, and cultural tips for couples learning {targetInfo.name}.
        </p>
      </div>
    </div>
  </header>

  <!-- Filter Bar -->
  <div class="sticky top-14 z-40 bg-white/90 backdrop-blur-lg border-b border-gray-100">
    <div class="max-w-6xl mx-auto px-4">
      <div class="flex gap-2 overflow-x-auto py-3 scrollbar-hide" id="filter-bar">
        {categories.map((cat, i) => (
          <button
            type="button"
            data-category={cat.id}
            class={`filter-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors cursor-pointer ${
              i === 0
                ? 'bg-accent text-white active'
                : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
            }`}
          >
            {cat.icon} {cat.label}
          </button>
        ))}
      </div>
    </div>
  </div>

  <!-- Article Grid -->
  <main class="max-w-6xl mx-auto px-4 py-8">
    {articles.length > 0 ? (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="article-grid">
        {articles.map((article) => (
          <div class="article-item" data-category={article.data.category}>
            <ArticleCard
              slug={article.slug}
              title={article.data.title}
              description={article.data.description}
              category={article.data.category}
              difficulty={article.data.difficulty}
              readTime={article.data.readTime}
              image={article.data.image}
              date={article.data.date}
            />
          </div>
        ))}
      </div>
    ) : (
      <div class="text-center py-20">
        <div class="text-6xl mb-4">{targetInfo.flag}</div>
        <h2 class="text-2xl font-bold text-gray-900 mb-2">{targetInfo.name} Articles Coming Soon!</h2>
        <p class="text-gray-600 mb-6">We're working on {targetInfo.name} content. Check back soon or explore another language.</p>
        <a href="/learn/" class="inline-block bg-accent text-white font-bold px-6 py-3 rounded-full hover:bg-accent/90 transition-colors">
          Browse All Languages
        </a>
      </div>
    )}
  </main>

  <!-- Testimonials -->
  <section class="max-w-6xl mx-auto px-4">
    <Testimonials />
  </section>

  <!-- Main CTA -->
  <section class="bg-gradient-to-r from-accent to-pink-500 py-16">
    <div class="max-w-2xl mx-auto px-4 text-center text-white">
      <h2 class="text-3xl font-bold font-header mb-4">
        Ready to Start Learning {targetInfo.name}?
      </h2>
      <p class="text-white/90 mb-8">
        Join couples learning {targetInfo.name} together with AI coaching, voice practice, and games.
      </p>
      <a
        href="/"
        class="inline-block bg-white text-accent font-bold px-8 py-4 rounded-full hover:shadow-lg hover:scale-105 transition-all text-lg"
      >
        Start Your Journey
      </a>
      <p class="mt-4 text-white/80 text-sm">
        Join couples learning languages across 30+ countries
      </p>
    </div>
  </section>

  <!-- Footer -->
  <footer class="bg-gray-100 border-t border-gray-200 py-12">
    <div class="max-w-6xl mx-auto px-4 text-center">
      <a href="/" class="inline-flex items-center gap-2 text-2xl font-bold font-header text-accent mb-4">
        <img src="/favicon.svg" alt="" class="w-8 h-8" />
        Love Languages
      </a>
      <p class="text-gray-600 mb-6">Learn any language together with your partner</p>
      <nav class="flex justify-center gap-6 text-sm text-gray-500">
        <a href="/learn/" class="hover:text-accent">Blog</a>
        <a href="/tools" class="hover:text-accent">Tools</a>
        <a href="/terms" class="hover:text-accent">Terms</a>
        <a href="/privacy" class="hover:text-accent">Privacy</a>
      </nav>
    </div>
  </footer>
</BaseLayout>

<style>
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  .article-item {
    transition: opacity 0.2s ease, transform 0.2s ease;
  }
  .article-item.hidden {
    display: none;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const filterButtons = document.querySelectorAll('.filter-btn');
    const articles = document.querySelectorAll('.article-item');

    filterButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const category = btn.getAttribute('data-category');

        // Update active button styles
        filterButtons.forEach(b => {
          b.classList.remove('bg-accent', 'text-white', 'active');
          b.classList.add('bg-gray-100', 'text-gray-600');
        });
        btn.classList.remove('bg-gray-100', 'text-gray-600');
        btn.classList.add('bg-accent', 'text-white', 'active');

        // Filter articles
        articles.forEach(article => {
          const articleCategory = article.getAttribute('data-category');
          if (category === 'all' || articleCategory === category) {
            article.classList.remove('hidden');
          } else {
            article.classList.add('hidden');
          }
        });
      });
    });
  });
</script>
