---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import ArticleCard from '../../../../components/ArticleCard.astro';
import LanguageSelector from '../../../../components/LanguageSelector.astro';
import Testimonials from '../../../../components/Testimonials.astro';
import { getArticlesByLangPair, getArticleCount } from '../../../../lib/blog-api';

// Language config for flags and names
const LANGUAGE_INFO: Record<string, { flag: string; name: string; nativeName: string }> = {
  en: { flag: 'ğŸ‡¬ğŸ‡§', name: 'English', nativeName: 'English' },
  es: { flag: 'ğŸ‡ªğŸ‡¸', name: 'Spanish', nativeName: 'EspaÃ±ol' },
  fr: { flag: 'ğŸ‡«ğŸ‡·', name: 'French', nativeName: 'FranÃ§ais' },
  it: { flag: 'ğŸ‡®ğŸ‡¹', name: 'Italian', nativeName: 'Italiano' },
  pt: { flag: 'ğŸ‡µğŸ‡¹', name: 'Portuguese', nativeName: 'PortuguÃªs' },
  ro: { flag: 'ğŸ‡·ğŸ‡´', name: 'Romanian', nativeName: 'RomÃ¢nÄƒ' },
  de: { flag: 'ğŸ‡©ğŸ‡ª', name: 'German', nativeName: 'Deutsch' },
  nl: { flag: 'ğŸ‡³ğŸ‡±', name: 'Dutch', nativeName: 'Nederlands' },
  sv: { flag: 'ğŸ‡¸ğŸ‡ª', name: 'Swedish', nativeName: 'Svenska' },
  no: { flag: 'ğŸ‡³ğŸ‡´', name: 'Norwegian', nativeName: 'Norsk' },
  da: { flag: 'ğŸ‡©ğŸ‡°', name: 'Danish', nativeName: 'Dansk' },
  pl: { flag: 'ğŸ‡µğŸ‡±', name: 'Polish', nativeName: 'Polski' },
  cs: { flag: 'ğŸ‡¨ğŸ‡¿', name: 'Czech', nativeName: 'ÄŒeÅ¡tina' },
  ru: { flag: 'ğŸ‡·ğŸ‡º', name: 'Russian', nativeName: 'Ğ ÑƒÑÑĞºĞ¸Ğ¹' },
  uk: { flag: 'ğŸ‡ºğŸ‡¦', name: 'Ukrainian', nativeName: 'Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°' },
  el: { flag: 'ğŸ‡¬ğŸ‡·', name: 'Greek', nativeName: 'Î•Î»Î»Î·Î½Î¹ÎºÎ¬' },
  hu: { flag: 'ğŸ‡­ğŸ‡º', name: 'Hungarian', nativeName: 'Magyar' },
  tr: { flag: 'ğŸ‡¹ğŸ‡·', name: 'Turkish', nativeName: 'TÃ¼rkÃ§e' },
};

// Generate static paths for all language pair combinations
export async function getStaticPaths() {
  const langs = Object.keys(LANGUAGE_INFO);
  const paths = [];
  for (const native of langs) {
    for (const target of langs) {
      if (native !== target) {
        paths.push({ params: { nativeLang: native, targetLang: target } });
      }
    }
  }
  return paths;
}

const SUPPORTED_LANGUAGES = Object.keys(LANGUAGE_INFO);

const { nativeLang, targetLang } = Astro.params;
const nativeLanguageCode = nativeLang || 'en';
const targetLanguageCode = targetLang || 'pl';

// Validate languages
if (!LANGUAGE_INFO[nativeLanguageCode] || !LANGUAGE_INFO[targetLanguageCode]) {
  return Astro.redirect('/learn/');
}

if (nativeLanguageCode === targetLanguageCode) {
  return Astro.redirect('/learn/');
}

const nativeInfo = LANGUAGE_INFO[nativeLanguageCode];
const targetInfo = LANGUAGE_INFO[targetLanguageCode];

// Get articles for this language pair from Supabase
const articles = await getArticlesByLangPair(nativeLanguageCode, targetLanguageCode, { limit: 100 });

// Get article counts per target language (for the current native language)
const languageCounts: Record<string, number> = {};
for (const code of SUPPORTED_LANGUAGES) {
  if (code !== nativeLanguageCode) {
    languageCounts[code] = await getArticleCount(nativeLanguageCode, code);
  }
}

// Category filters
const categories = [
  { id: 'all', label: 'All', icon: 'ğŸ“–' },
  { id: 'phrases', label: 'Phrases', icon: 'ğŸ’¬' },
  { id: 'vocabulary', label: 'Vocabulary', icon: 'ğŸ“š' },
  { id: 'grammar', label: 'Grammar', icon: 'ğŸ“' },
  { id: 'culture', label: 'Culture', icon: targetInfo.flag },
  { id: 'situations', label: 'Situations', icon: 'ğŸ­' },
];

// Hreflang alternates
const SUPPORTED_NATIVE_LANGS = ['en', 'es', 'fr', 'de', 'it', 'pt', 'pl', 'nl', 'ro', 'ru', 'tr', 'uk', 'sv', 'no', 'da', 'cs', 'el', 'hu'];
const hreflangAlternates = SUPPORTED_NATIVE_LANGS
  .filter(lang => lang !== nativeLanguageCode && lang !== targetLanguageCode)
  .map(lang => ({
    lang,
    href: `https://www.lovelanguages.io/learn/${lang}/${targetLanguageCode}/`
  }));

const canonicalUrl = `https://www.lovelanguages.io/learn/${nativeLanguageCode}/${targetLanguageCode}/`;
const xDefaultUrl = nativeLanguageCode === 'en' ? canonicalUrl : `https://www.lovelanguages.io/learn/en/${targetLanguageCode}/`;

// JSON-LD
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "Blog",
  "name": `Love Languages - Learn ${targetInfo.name} Blog`,
  "description": `Free ${targetInfo.name} lessons, vocabulary guides, and cultural tips for couples learning together.`,
  "url": canonicalUrl,
  "inLanguage": nativeLanguageCode,
  "publisher": {
    "@type": "Organization",
    "name": "Love Languages",
    "url": "https://www.lovelanguages.io"
  }
};
---

<BaseLayout
  title={`Learn ${targetInfo.name} - Free Lessons for Couples`}
  description={`Free ${targetInfo.name} lessons, vocabulary guides, and cultural tips designed for couples learning together. Start your ${targetInfo.name} language journey today.`}
  nativeLang={nativeLanguageCode}
  targetLang={targetLanguageCode}
>
  <Fragment slot="head">
    <link rel="canonical" href={canonicalUrl} />
    <link rel="alternate" hreflang={nativeLanguageCode} href={canonicalUrl} />
    <link rel="alternate" hreflang="x-default" href={xDefaultUrl} />
    {hreflangAlternates.map(alt => (
      <link rel="alternate" hreflang={alt.lang} href={alt.href} />
    ))}
  </Fragment>

  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

  <!-- Hero Section -->
  <header class="bg-gradient-to-b from-accent/10 to-white">
    <div class="max-w-6xl mx-auto px-4 py-6 md:py-8">
      <div class="text-center max-w-2xl mx-auto">
        <div class="mb-4">
          <LanguageSelector
            currentLang={targetLanguageCode}
            nativeLang={nativeLanguageCode}
            languageInfo={LANGUAGE_INFO}
            languageCounts={languageCounts}
          />
        </div>
        <h1 class="text-3xl md:text-4xl font-black font-header text-gray-900 mb-2">
          <span class="text-4xl md:text-5xl">{targetInfo.flag}</span> Learn {targetInfo.name} Together
        </h1>
        <p class="text-lg text-gray-600">
          Lessons, vocabulary guides, and cultural tips for couples learning {targetInfo.name}.
        </p>
      </div>
    </div>
  </header>

  <!-- Filter Bar -->
  <div class="sticky top-14 z-40 bg-white/90 backdrop-blur-lg border-b border-gray-100">
    <div class="max-w-6xl mx-auto px-4">
      <div class="flex gap-2 overflow-x-auto py-3 scrollbar-hide" id="filter-bar">
        {categories.map((cat, i) => (
          <button
            type="button"
            data-category={cat.id}
            class={`filter-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors cursor-pointer ${
              i === 0
                ? 'bg-accent text-white active'
                : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
            }`}
          >
            {cat.icon} {cat.label}
          </button>
        ))}
      </div>
    </div>
  </div>

  <!-- Article Grid -->
  <main class="max-w-6xl mx-auto px-4 py-8">
    {articles.length > 0 ? (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="article-grid">
        {articles.map((article) => (
          <div class="article-item" data-category={article.category}>
            <ArticleCard
              slug={`${article.native_lang}/${article.target_lang}/${article.slug}`}
              title={article.title}
              description={article.description || ''}
              category={article.category || 'general'}
              difficulty={article.difficulty || 'beginner'}
              readTime={article.read_time || 5}
              image={article.image || ''}
              date={article.date || new Date().toISOString()}
            />
          </div>
        ))}
      </div>
    ) : (
      <div class="text-center py-20">
        <div class="text-6xl mb-4">{targetInfo.flag}</div>
        <h2 class="text-2xl font-bold text-gray-900 mb-2">{targetInfo.name} Articles Coming Soon!</h2>
        <p class="text-gray-600 mb-6">We're working on {targetInfo.name} content. Check back soon or explore another language.</p>
        <a href="/learn/" class="inline-block bg-accent text-white font-bold px-6 py-3 rounded-full hover:bg-accent/90 transition-colors">
          Browse All Languages
        </a>
      </div>
    )}
  </main>

  <!-- Testimonials -->
  <section class="max-w-6xl mx-auto px-4">
    <Testimonials />
  </section>

  <!-- Main CTA -->
  <section class="bg-gradient-to-r from-accent to-pink-500 py-16">
    <div class="max-w-2xl mx-auto px-4 text-center text-white">
      <h2 class="text-3xl font-bold font-header mb-4">
        Ready to Start Learning {targetInfo.name}?
      </h2>
      <p class="text-white/90 mb-8">
        Join couples learning {targetInfo.name} together with AI coaching, voice practice, and games.
      </p>
      <a
        href="/"
        class="inline-block bg-white text-accent font-bold px-8 py-4 rounded-full hover:shadow-lg hover:scale-105 transition-all text-lg"
      >
        Start Your Journey
      </a>
    </div>
  </section>

  <!-- Footer -->
  <footer class="bg-gray-100 border-t border-gray-200 py-12">
    <div class="max-w-6xl mx-auto px-4 text-center">
      <a href="/" class="inline-flex items-center gap-2 text-2xl font-bold font-header text-accent mb-4">
        <img src="/favicon.svg" alt="" class="w-8 h-8" />
        Love Languages
      </a>
      <p class="text-gray-600 mb-6">Learn any language together with your partner</p>
      <nav class="flex justify-center gap-6 text-sm text-gray-500">
        <a href="/learn/" class="hover:text-accent">Blog</a>
        <a href="/tools" class="hover:text-accent">Tools</a>
      </nav>
    </div>
  </footer>
</BaseLayout>

<style>
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  .article-item.hidden {
    display: none;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const filterButtons = document.querySelectorAll('.filter-btn');
    const articles = document.querySelectorAll('.article-item');

    filterButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const category = btn.getAttribute('data-category');

        filterButtons.forEach(b => {
          b.classList.remove('bg-accent', 'text-white', 'active');
          b.classList.add('bg-gray-100', 'text-gray-600');
        });
        btn.classList.remove('bg-gray-100', 'text-gray-600');
        btn.classList.add('bg-accent', 'text-white', 'active');

        articles.forEach(article => {
          const articleCategory = article.getAttribute('data-category');
          if (category === 'all' || articleCategory === category) {
            article.classList.remove('hidden');
          } else {
            article.classList.add('hidden');
          }
        });
      });
    });
  });
</script>
