---
/**
 * NativeLanguageSelector - Switch between native language versions of articles
 * E.g., switch from English articles about Polish to Spanish articles about Polish
 */

interface LanguageInfo {
  flag: string;
  name: string;
  nativeName: string;
}

interface Props {
  currentNativeLang: string;
  targetLang: string;
  languageInfo: Record<string, LanguageInfo>;
  availableNativeLanguages?: string[];  // Native languages that have content for this target
}

// Supported native languages for content (languages with translated articles)
const SUPPORTED_NATIVE_LANGS = ['en', 'es', 'fr'];  // Expand as content is added

const {
  currentNativeLang,
  targetLang,
  languageInfo,
  availableNativeLanguages = SUPPORTED_NATIVE_LANGS
} = Astro.props;

const currentInfo = languageInfo[currentNativeLang];

// Filter to only show available native languages (excluding current)
const otherNativeLanguages = availableNativeLanguages
  .filter(code => code !== currentNativeLang && code !== targetLang)
  .map(code => ({ code, info: languageInfo[code] }))
  .filter(item => item.info);  // Only include languages with info
---

<div class="native-lang-selector relative inline-block">
  <button
    type="button"
    class="native-trigger flex items-center gap-2 px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-full text-sm transition-all cursor-pointer"
    aria-haspopup="listbox"
    aria-expanded="false"
    title="Change article language"
  >
    <span class="text-base">{currentInfo.flag}</span>
    <span class="font-medium text-gray-700">{currentInfo.nativeName}</span>
    <svg class="w-3 h-3 text-gray-400 transition-transform native-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
  </button>

  <div class="native-dropdown absolute top-full right-0 mt-2 w-56 bg-white border border-gray-200 rounded-xl shadow-xl opacity-0 invisible transition-all z-50">
    <div class="p-2">
      <div class="px-3 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">
        Read articles in
      </div>

      {/* Current language */}
      <div class="flex items-center gap-3 px-3 py-2 rounded-lg bg-accent/10 text-accent">
        <span class="text-xl">{currentInfo.flag}</span>
        <div class="flex-1">
          <div class="font-medium">{currentInfo.nativeName}</div>
          <div class="text-xs opacity-70">{currentInfo.name}</div>
        </div>
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
        </svg>
      </div>

      {/* Other languages */}
      {otherNativeLanguages.map(({ code, info }) => (
        <a
          href={`/learn/${code}/${targetLang}/`}
          class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 text-gray-700 transition-colors"
        >
          <span class="text-xl">{info.flag}</span>
          <div class="flex-1">
            <div class="font-medium">{info.nativeName}</div>
            <div class="text-xs text-gray-400">{info.name}</div>
          </div>
        </a>
      ))}
    </div>
  </div>
</div>

<style>
  .native-lang-selector.open .native-dropdown {
    opacity: 1;
    visibility: visible;
  }

  .native-lang-selector.open .native-chevron {
    transform: rotate(180deg);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const selector = document.querySelector('.native-lang-selector');
    const trigger = selector?.querySelector('.native-trigger');

    if (!selector || !trigger) return;

    // Toggle dropdown
    trigger.addEventListener('click', (e) => {
      e.stopPropagation();
      selector.classList.toggle('open');
      trigger.setAttribute('aria-expanded', selector.classList.contains('open').toString());
    });

    // Close on outside click
    document.addEventListener('click', (e) => {
      if (!selector.contains(e.target as Node)) {
        selector.classList.remove('open');
        trigger.setAttribute('aria-expanded', 'false');
      }
    });

    // Close on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        selector.classList.remove('open');
        trigger.setAttribute('aria-expanded', 'false');
      }
    });
  });
</script>
