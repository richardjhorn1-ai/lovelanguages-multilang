---
interface Props {
  text?: string;
  buttonText?: string;
  showSocialProof?: boolean;
  language?: string;
  articleSlug?: string;
  nativeLang?: string;
  targetLang?: string;
  topic?: string;
}

const CTA_TRANSLATIONS: Record<string, { subtitle: string; socialProof: string }> = {
  en: { subtitle: "Speak their language, touch their heart. Fun games, voice practice & goals made for two.", socialProof: "✨ Try free — no credit card needed" },
  es: { subtitle: "Habla su idioma, toca su corazón. Juegos, práctica de voz y metas para dos.", socialProof: "✨ Prueba gratis — sin tarjeta" },
  fr: { subtitle: "Parlez leur langue, touchez leur cœur. Jeux, pratique vocale et objectifs pour deux.", socialProof: "✨ Essai gratuit — sans carte" },
  de: { subtitle: "Sprich ihre Sprache, berühre ihr Herz. Spiele, Sprachübungen & Ziele für zwei.", socialProof: "✨ Kostenlos testen — keine Karte" },
  it: { subtitle: "Parla la loro lingua, tocca il loro cuore. Giochi, pratica vocale e obiettivi per due.", socialProof: "✨ Prova gratis — senza carta" },
  pt: { subtitle: "Fale a língua deles, toque o coração deles. Jogos, prática de voz e metas para dois.", socialProof: "✨ Experimente grátis — sem cartão" },
  pl: { subtitle: "Mów ich językiem, dotknij ich serca. Gry, ćwiczenia głosowe i cele dla dwojga.", socialProof: "✨ Wypróbuj za darmo — bez karty" },
  ru: { subtitle: "Говорите на их языке, коснитесь их сердца. Игры, голосовая практика и цели для двоих.", socialProof: "✨ Попробуйте бесплатно — без карты" },
  nl: { subtitle: "Spreek hun taal, raak hun hart. Spelletjes, spraakpraktijk & doelen voor twee.", socialProof: "✨ Probeer gratis — geen kaart nodig" },
  ro: { subtitle: "Vorbește limba lor, atinge-le inima. Jocuri, practică vocală și obiective pentru doi.", socialProof: "✨ Încearcă gratuit — fără card" },
  uk: { subtitle: "Говоріть їхньою мовою, торкніться їхнього серця. Ігри, голосова практика та цілі для двох.", socialProof: "✨ Спробуйте безкоштовно — без картки" },
  tr: { subtitle: "Onların dilini konuşun, kalplerini dokunun. Oyunlar, ses pratiği ve ikisi için hedefler.", socialProof: "✨ Ücretsiz deneyin — kart gerekmez" },
  sv: { subtitle: "Tala deras språk, rör deras hjärta. Spel, röstövningar & mål för två.", socialProof: "✨ Prova gratis — inget kort behövs" },
  no: { subtitle: "Snakk deres språk, berør deres hjerte. Spill, stemmeøvelser og mål for to.", socialProof: "✨ Prøv gratis — ingen kort nødvendig" },
  da: { subtitle: "Tal deres sprog, rør deres hjerte. Spil, stemmeøvelser og mål for to.", socialProof: "✨ Prøv gratis — intet kort påkrævet" },
  cs: { subtitle: "Mluvte jejich jazykem, dotkněte se jejich srdce. Hry, hlasová praxe a cíle pro dva.", socialProof: "✨ Vyzkoušejte zdarma — bez karty" },
  el: { subtitle: "Μιλήστε τη γλώσσα τους, αγγίξτε την καρδιά τους. Παιχνίδια, φωνητική εξάσκηση και στόχοι για δύο.", socialProof: "✨ Δοκιμάστε δωρεάν — χωρίς κάρτα" },
  hu: { subtitle: "Beszéld a nyelvüket, érintsd meg a szívüket. Játékok, hanggyakorlás és célok kettesben.", socialProof: "✨ Próbáld ki ingyen — kártya nélkül" },
};

const {
  text = "Ready to learn together?",
  buttonText = "Start Learning for $0",
  showSocialProof = true,
} = Astro.props;

// Extract article context from URL
const pathname = Astro.url.pathname;
const pathParts = pathname.split('/').filter(Boolean);
// URL pattern: /learn/{native}/{target}/{slug}
const nativeLang = pathParts[1] && pathParts[1].length === 2 ? pathParts[1] : 'en';
const targetLang = pathParts[2] && pathParts[2].length === 2 ? pathParts[2] : '';
const articleSlug = pathParts[3] || '';

const translations = CTA_TRANSLATIONS[nativeLang] || CTA_TRANSLATIONS.en;

// Build UTM-tagged URL for attribution
const utmParams = new URLSearchParams({
  utm_source: 'blog',
  utm_medium: 'article',
  utm_campaign: `${nativeLang}-${targetLang}`,
  utm_content: articleSlug,
  ref_native: nativeLang,
  ref_target: targetLang,
});
const ctaUrl = `/?${utmParams.toString()}`;
---

<div class="mt-12 bg-gradient-to-r from-accent to-pink-500 rounded-2xl p-8 text-center text-white">
  <h3 class="text-2xl font-bold font-header mb-3">{text}</h3>
  <p class="text-white/90 mb-5 text-lg">{translations.subtitle}</p>
  <a
    href={ctaUrl}
    class="inline-block bg-white text-accent font-bold px-8 py-4 rounded-full hover:shadow-lg hover:scale-105 transition-all text-lg cta-button"
    data-native={nativeLang}
    data-target={targetLang}
    data-article={articleSlug}
  >
    {buttonText} →
  </a>
  {showSocialProof && (
    <p class="mt-4 text-white/80 text-sm">
      {translations.socialProof}
    </p>
  )}
</div>

<script>
  // Track CTA clicks with full context
  document.querySelectorAll('.cta-button').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const target = e.currentTarget as HTMLElement;
      if (typeof gtag !== 'undefined') {
        gtag('event', 'blog_cta_click', {
          native_lang: target.dataset.native,
          target_lang: target.dataset.target,
          article_slug: target.dataset.article,
          page_path: window.location.pathname,
          event_category: 'conversion',
          event_label: `${target.dataset.native}-${target.dataset.target}`,
        });
      }
    });
  });
</script>
