---
import BaseLayout from './BaseLayout.astro';

interface RelatedArticle {
  slug: string;
  data: {
    title: string;
    description: string;
    category: string;
    readTime: number;
    image?: string;
  };
}

interface LanguageInfo {
  flag: string;
  name: string;
  nativeName: string;
}

interface AlternateVersion {
  nativeLang: string;
  href: string;
}

interface CrossPairArticle {
  slug: string;
  data: {
    title: string;
    description: string;
    category: string;
    readTime: number;
    language?: string;
    nativeLanguage?: string;
  };
}

interface ReverseArticle {
  slug: string;
  data: {
    title: string;
    description: string;
    category: string;
    readTime: number;
    language?: string;
    nativeLanguage?: string;
  };
}

interface Props {
  title: string;
  description: string;
  category: 'phrases' | 'vocabulary' | 'grammar' | 'culture' | 'situations' | 'pronunciation';
  difficulty: 'beginner' | 'intermediate' | 'advanced';
  readTime: number;
  image?: string;
  date: string;
  tags?: string[];
  relatedArticles?: RelatedArticle[];
  languageCode?: string;
  languageInfo?: LanguageInfo;
  nativeLanguageCode?: string;
  nativeLanguageInfo?: LanguageInfo;
  alternateVersions?: AlternateVersion[];  // For hreflang support
  reverseArticle?: ReverseArticle;  // SEO: Link to reverse language pair
  crossPairArticles?: CrossPairArticle[];  // SEO: Similar topics in other pairs
}

// AEO: Detect if article is a "How to" guide (multilingual patterns)
function isHowToArticle(title: string): boolean {
  const howToPatterns = [
    /^how to /i,           // English
    /^comment /i,          // French
    /^c√≥mo /i,             // Spanish
    /^wie man /i,          // German
    /^come /i,             // Italian
    /^como /i,             // Portuguese
    /^jak /i,              // Polish
    /^œÄœéœÇ ŒΩŒ± /i,           // Greek
    /^nasƒ±l /i,            // Turkish
    /^–∫–∞–∫ /i,              // Russian
    /^hoe /i,              // Dutch
  ];
  return howToPatterns.some(pattern => pattern.test(title));
}

// AEO: Generate FAQ items based on article category and language
function generateFAQItems(title: string, languageName: string, category: string): Array<{question: string, answer: string}> {
  const faqs: Array<{question: string, answer: string}> = [];

  // Category-specific FAQs
  if (category === 'phrases') {
    faqs.push({
      question: `How do I practice these ${languageName} phrases with my partner?`,
      answer: `The best way is to use them in daily conversations. Start with simple phrases like greetings and gradually add romantic expressions. Practice during meals, morning routines, or before bed to build consistency.`
    });
  }

  if (category === 'vocabulary') {
    faqs.push({
      question: `How long does it take to memorize ${languageName} vocabulary?`,
      answer: `With regular practice as a couple, you can learn 5-10 new words per week effectively. Spaced repetition and using words in real conversations with your partner accelerates retention significantly.`
    });
  }

  if (category === 'grammar') {
    faqs.push({
      question: `Is ${languageName} grammar difficult to learn?`,
      answer: `Every language has challenging aspects, but learning together with a partner makes it easier. Focus on patterns used in everyday conversation first, then expand to more complex structures over time.`
    });
  }

  if (category === 'pronunciation') {
    faqs.push({
      question: `How can I improve my ${languageName} pronunciation?`,
      answer: `Practice with your partner daily, listen to native speakers, and record yourself speaking. Having a native-speaking partner or using language learning apps with audio can help perfect difficult sounds.`
    });
  }

  // Universal FAQ for all articles
  faqs.push({
    question: `Can couples really learn ${languageName} together effectively?`,
    answer: `Absolutely! Couples who learn together have built-in practice partners, natural motivation, and can incorporate the language into daily life. Studies show social learning significantly improves retention and enjoyment.`
  });

  return faqs;
}

const {
  title, description, category, difficulty, readTime, image, date, tags,
  relatedArticles = [],
  languageCode = 'pl',
  languageInfo = { flag: 'üáµüá±', name: 'Polish', nativeName: 'Polski' },
  nativeLanguageCode = 'en',
  nativeLanguageInfo = { flag: 'üá¨üáß', name: 'English', nativeName: 'English' },
  alternateVersions = [],
  reverseArticle,
  crossPairArticles = []
} = Astro.props;

// Language info lookup for cross-pair display
const LANG_FLAGS: Record<string, string> = {
  en: 'üá¨üáß', es: 'üá™üá∏', fr: 'üá´üá∑', de: 'üá©üá™', it: 'üáÆüáπ', pt: 'üáµüáπ',
  pl: 'üáµüá±', nl: 'üá≥üá±', ru: 'üá∑üá∫', uk: 'üá∫üá¶', el: 'üá¨üá∑', tr: 'üáπüá∑',
  cs: 'üá®üáø', hu: 'üá≠üá∫', ro: 'üá∑üá¥', sv: 'üá∏üá™', no: 'üá≥üá¥', da: 'üá©üá∞'
};

// Build canonical URL
const canonicalUrl = `https://lovelanguages.io${Astro.url.pathname}`;

// Use language flag for culture category
const categoryConfig = {
  phrases: { icon: 'üí¨', bg: 'bg-rose-100', text: 'text-rose-700', label: 'Phrases' },
  vocabulary: { icon: 'üìö', bg: 'bg-purple-100', text: 'text-purple-700', label: 'Vocabulary' },
  grammar: { icon: 'üìù', bg: 'bg-blue-100', text: 'text-blue-700', label: 'Grammar' },
  culture: { icon: languageInfo.flag, bg: 'bg-amber-100', text: 'text-amber-700', label: 'Culture' },
  situations: { icon: 'üé≠', bg: 'bg-emerald-100', text: 'text-emerald-700', label: 'Situations' },
  pronunciation: { icon: 'üó£Ô∏è', bg: 'bg-teal-100', text: 'text-teal-700', label: 'Pronunciation' },
};

const cat = categoryConfig[category];

const formattedDate = new Date(date).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

// JSON-LD structured data
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": title,
  "description": description,
  "image": image ? `https://lovelanguages.io${image}` : "https://lovelanguages.io/og-image.png",
  "datePublished": date,
  "dateModified": date,
  "author": {
    "@type": "Organization",
    "name": "Love Languages",
    "url": "https://lovelanguages.io"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Love Languages",
    "logo": {
      "@type": "ImageObject",
      "url": "https://lovelanguages.io/favicon.svg"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": `https://lovelanguages.io${Astro.url.pathname}`
  },
  "articleSection": category,
  "keywords": tags?.join(', ')
};

// Hub page URL for this language
const languageHubUrl = `/learn/language/${languageInfo.name.toLowerCase()}/`;

const breadcrumbJsonLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://lovelanguages.io"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Learn",
      "item": "https://lovelanguages.io/learn/"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": `Learn ${languageInfo.name}`,
      "item": `https://lovelanguages.io${languageHubUrl}`
    },
    {
      "@type": "ListItem",
      "position": 4,
      "name": title,
      "item": canonicalUrl
    }
  ]
};

// AEO: HowTo Schema for instructional articles
const isHowTo = isHowToArticle(title);
const howToJsonLd = isHowTo ? {
  "@context": "https://schema.org",
  "@type": "HowTo",
  "name": title,
  "description": description,
  "image": image ? `https://lovelanguages.io${image}` : "https://lovelanguages.io/og-image.png",
  "totalTime": `PT${readTime}M`,
  "estimatedCost": {
    "@type": "MonetaryAmount",
    "currency": "USD",
    "value": "0"
  },
  "supply": [{
    "@type": "HowToSupply",
    "name": "Love Languages app or practice partner"
  }],
  "tool": [{
    "@type": "HowToTool",
    "name": "Notebook or digital notes for vocabulary"
  }],
  "step": [
    {
      "@type": "HowToStep",
      "position": 1,
      "name": "Read and understand",
      "text": `Read through this ${languageInfo.name} guide with your partner to understand the key concepts and vocabulary.`
    },
    {
      "@type": "HowToStep",
      "position": 2,
      "name": "Practice pronunciation",
      "text": `Practice saying the ${languageInfo.name} words and phrases out loud together. Use the pronunciation guides provided.`
    },
    {
      "@type": "HowToStep",
      "position": 3,
      "name": "Use in conversation",
      "text": `Start using these ${languageInfo.name} expressions in your daily conversations with your partner.`
    },
    {
      "@type": "HowToStep",
      "position": 4,
      "name": "Review and reinforce",
      "text": "Return to this guide regularly to reinforce your learning and add new vocabulary to your practice."
    }
  ]
} : null;

// AEO: FAQ Schema for enhanced search visibility
const faqItems = generateFAQItems(title, languageInfo.name, category);
const faqJsonLd = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": faqItems.map(faq => ({
    "@type": "Question",
    "name": faq.question,
    "acceptedAnswer": {
      "@type": "Answer",
      "text": faq.answer
    }
  }))
};
---

<BaseLayout
  title={title}
  description={description}
  image={image}
  article={{
    publishedTime: date,
    section: category,
    tags: tags,
  }}
  nativeLang={nativeLanguageCode}
  targetLang={languageCode}
>
  <Fragment slot="head">
    {/* Core Article Schema */}
    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbJsonLd)} />

    {/* AEO: HowTo Schema for instructional articles */}
    {howToJsonLd && (
      <script type="application/ld+json" set:html={JSON.stringify(howToJsonLd)} />
    )}

    {/* AEO: FAQ Schema for enhanced search visibility */}
    <script type="application/ld+json" set:html={JSON.stringify(faqJsonLd)} />

    {/* Canonical URL */}
    <link rel="canonical" href={canonicalUrl} />

    {/* Hreflang tags for multi-language SEO */}
    <link rel="alternate" hreflang={languageCode} href={canonicalUrl} />
    <link rel="alternate" hreflang="x-default" href={canonicalUrl} />
    {alternateVersions.map(alt => (
      <link rel="alternate" hreflang={alt.nativeLang} href={alt.href} />
    ))}
  </Fragment>

  <!-- Breadcrumb -->
  <nav class="max-w-3xl mx-auto px-4 py-3 bg-gray-50">
    <ol class="flex items-center gap-2 text-sm text-gray-500">
      <li><a href="/" class="hover:text-accent">Home</a></li>
      <li>/</li>
      <li><a href="/learn/" class="hover:text-accent">Learn</a></li>
      <li>/</li>
      <li><a href={languageHubUrl} class="hover:text-accent">{languageInfo.flag} {languageInfo.name}</a></li>
      <li>/</li>
      <li class="text-gray-900 truncate max-w-[200px]">{title}</li>
    </ol>
  </nav>

  <!-- Hero Image or Emoji Fallback -->
  <div class="relative h-64 md:h-80 bg-gradient-to-br from-accent/20 to-pink-100 hero-container" data-emoji={cat.icon}>
    {image ? (
      <img
        src={image}
        alt={title}
        class="hero-image w-full h-full object-cover"
        loading="eager"
        onerror="this.style.display='none'"
      />
    ) : null}
    <div class="hero-emoji absolute inset-0 flex items-center justify-center text-8xl opacity-30">
      {cat.icon}
    </div>
  </div>

  <style>
    .hero-container {
      position: relative;
    }
    .hero-image {
      position: relative;
      z-index: 1;
    }
    .hero-emoji {
      z-index: 0;
    }
    /* When image loads successfully, it covers the emoji */
    .hero-image:not([style*="display: none"]) ~ .hero-emoji {
      display: none;
    }
  </style>

  <!-- Article Content Card -->
  <main class="max-w-3xl mx-auto px-4 -mt-16 relative z-10 pb-16">
    <article class="bg-white rounded-2xl shadow-lg p-6 md:p-10">
      <!-- Meta -->
      <div class="flex flex-wrap items-center gap-3 mb-6 text-sm">
        <span class={`px-3 py-1 rounded-full font-bold ${cat.bg} ${cat.text}`}>
          {cat.icon} {cat.label}
        </span>
        <span class="text-gray-500">{formattedDate}</span>
        <span class="text-gray-500">{readTime} min read</span>
      </div>

      <!-- Title -->
      <h1 class="text-3xl md:text-4xl font-black font-header text-gray-900 mb-6 leading-tight">
        {title}
      </h1>

      <!-- Content -->
      <div class="prose max-w-none">
        <slot />
      </div>
    </article>

    <!-- Explore More CTA -->
    <div class="mt-8 p-6 bg-gradient-to-r from-accent/5 to-pink-50 rounded-2xl border border-accent/10">
      <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
        <div class="text-center sm:text-left">
          <p class="text-gray-600 text-sm mb-1">Want to learn more?</p>
          <p class="font-bold text-gray-900">Explore our complete {languageInfo.name} guide</p>
        </div>
        <a
          href={languageHubUrl}
          class="inline-flex items-center gap-2 px-5 py-2.5 bg-accent text-white font-bold rounded-full hover:shadow-lg hover:scale-105 transition-all text-sm"
        >
          {languageInfo.flag} {languageInfo.name} Hub
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
          </svg>
        </a>
      </div>
    </div>
  </main>

  <!-- Related Articles -->
  {relatedArticles.length > 0 && (
    <section class="max-w-3xl mx-auto px-4 pb-16">
      <h2 class="text-2xl font-bold font-header text-gray-900 mb-6">Keep Learning</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        {relatedArticles.map((related) => {
          const relCat = categoryConfig[related.data.category as keyof typeof categoryConfig];
          return (
            <a
              href={`/learn/${related.slug}/`}
              class="group bg-white rounded-xl shadow-md hover:shadow-lg transition-shadow overflow-hidden"
            >
              <div class="aspect-video bg-gradient-to-br from-accent/20 to-pink-100 relative">
                {related.data.image ? (
                  <img
                    src={related.data.image}
                    alt={related.data.title}
                    class="w-full h-full object-cover"
                    loading="lazy"
                  />
                ) : (
                  <div class="absolute inset-0 flex items-center justify-center text-4xl opacity-30">
                    {relCat?.icon || 'üìñ'}
                  </div>
                )}
              </div>
              <div class="p-4">
                <span class={`inline-block px-2 py-0.5 rounded-full text-xs font-bold mb-2 ${relCat?.bg || 'bg-gray-100'} ${relCat?.text || 'text-gray-700'}`}>
                  {relCat?.icon} {relCat?.label || related.data.category}
                </span>
                <h3 class="font-bold text-gray-900 group-hover:text-accent transition-colors line-clamp-2">
                  {related.data.title}
                </h3>
                <p class="text-sm text-gray-500 mt-1">{related.data.readTime} min read</p>
              </div>
            </a>
          );
        })}
      </div>
    </section>
  )}

  <!-- SEO: Reverse Language Pair Link -->
  {reverseArticle && (
    <section class="max-w-3xl mx-auto px-4 pb-8">
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-100">
        <div class="flex items-center gap-3 mb-3">
          <span class="text-2xl">üîÑ</span>
          <h3 class="font-bold text-gray-900">Learn the Reverse!</h3>
        </div>
        <p class="text-gray-600 text-sm mb-4">
          {nativeLanguageInfo.flag} {nativeLanguageInfo.name} speaker learning {languageInfo.flag} {languageInfo.name}?
          Check out the reverse perspective:
        </p>
        <a
          href={`/learn/${reverseArticle.slug}/`}
          class="inline-flex items-center gap-2 px-4 py-2 bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow text-sm font-medium text-gray-900"
        >
          <span>{languageInfo.flag} ‚Üí {nativeLanguageInfo.flag}</span>
          <span class="text-gray-600 truncate max-w-[200px]">{reverseArticle.data.title}</span>
          <svg class="w-4 h-4 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </a>
      </div>
    </section>
  )}

  <!-- SEO: Cross-Language Pair Articles (Similar Topics) -->
  {crossPairArticles.length > 0 && (
    <section class="max-w-3xl mx-auto px-4 pb-12">
      <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
        <span>üåç</span> Similar Topics in Other Languages
      </h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        {crossPairArticles.map((article) => {
          const parts = article.slug.split('/');
          const fromLang = parts[0];
          const toLang = parts[1];
          return (
            <a
              href={`/learn/${article.slug}/`}
              class="flex items-center gap-3 p-3 bg-white rounded-lg border border-gray-100 hover:border-accent/30 hover:shadow-sm transition-all group"
            >
              <span class="text-lg">
                {LANG_FLAGS[fromLang] || 'üåê'} ‚Üí {LANG_FLAGS[toLang] || 'üåê'}
              </span>
              <div class="flex-1 min-w-0">
                <p class="font-medium text-gray-900 group-hover:text-accent transition-colors text-sm truncate">
                  {article.data.title}
                </p>
                <p class="text-xs text-gray-500">{article.data.readTime} min read</p>
              </div>
            </a>
          );
        })}
      </div>
    </section>
  )}

  <!-- Sticky Mobile CTA -->
  <div class="fixed bottom-0 left-0 right-0 bg-gradient-to-r from-accent to-pink-500 p-3 md:hidden z-50 shadow-lg">
    <a
      href="/"
      class="flex items-center justify-center gap-2 text-white font-bold"
    >
      <span>Learn {languageInfo.name} Together</span>
      <span class="bg-white text-accent px-3 py-1 rounded-full text-sm">Start Now ‚Üí</span>
    </a>
  </div>

  <!-- Spacer for sticky CTA on mobile -->
  <div class="h-16 md:hidden"></div>

  <!-- Footer -->
  <footer class="bg-gray-100 border-t border-gray-200 py-12">
    <div class="max-w-3xl mx-auto px-4 text-center">
      <a href="/" class="inline-flex items-center gap-2 text-2xl font-bold font-header text-accent mb-4">
        <img src="/favicon.svg" alt="" class="w-8 h-8" />
        Love Languages
      </a>
      <p class="text-gray-600 mb-6">Learn {languageInfo.name} together with your partner</p>
      <nav class="flex justify-center gap-6 text-sm text-gray-500">
        <a href="/learn/" class="hover:text-accent">Blog</a>
        <a href="/tools" class="hover:text-accent">Tools</a>
        <a href="/terms" class="hover:text-accent">Terms</a>
        <a href="/privacy" class="hover:text-accent">Privacy</a>
      </nav>
    </div>
  </footer>
</BaseLayout>
