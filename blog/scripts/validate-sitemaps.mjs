/**
 * Post-build Sitemap Validation
 *
 * Runs after `astro build` to catch misconfigurations that would
 * cause static files to override SSR sitemap endpoints on Vercel.
 *
 * Vercel serves static files before SSR routes (handle: "filesystem").
 * If a postbuild script accidentally writes sitemap-index.xml to dist/,
 * it silently replaces our dynamic SSR endpoint with stale content.
 *
 * This script fails the build if it detects dangerous static files.
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const DIST_DIR = path.join(__dirname, '..', 'dist');

// Static files that would override our SSR endpoints
const BLOCKED_FILES = [
  'sitemap-index.xml',    // SSR: src/pages/sitemap-index.xml.ts
  'sitemap-pages.xml',    // SSR: src/pages/sitemap-pages.xml.ts
  'sitemap-articles.xml', // SSR: src/pages/sitemap-articles.xml.ts
  'sitemap-app.xml',      // Removed — was from generate-app-sitemap.mjs
  'sitemap-0.xml',        // Old @astrojs/sitemap output — should not exist
];

// Files that SHOULD exist as static (generated by postbuild)
const EXPECTED_FILES = [
  'sitemap-images.xml',   // Generated by generate-image-sitemap.mjs
];

let failed = false;

// Check dist/ and dist/client/ (Astro SSR outputs to dist/client/)
const dirsToCheck = [DIST_DIR, path.join(DIST_DIR, 'client')];

for (const dir of dirsToCheck) {
  if (!fs.existsSync(dir)) continue;

  for (const file of BLOCKED_FILES) {
    const filePath = path.join(dir, file);
    if (fs.existsSync(filePath)) {
      console.error(`\x1b[31mERROR: ${path.relative(DIST_DIR, filePath)} exists in dist/\x1b[0m`);
      console.error(`  This static file will override the SSR endpoint on Vercel.`);
      console.error(`  A postbuild script may be writing files it shouldn't.`);
      failed = true;
    }
  }
}

// Verify expected files exist
for (const file of EXPECTED_FILES) {
  const filePath = path.join(DIST_DIR, file);
  if (!fs.existsSync(filePath)) {
    console.warn(`\x1b[33mWARNING: Expected ${file} not found in dist/\x1b[0m`);
    console.warn(`  generate-image-sitemap.mjs may have failed.`);
    // Warning only — don't fail the build for images
  }
}

if (failed) {
  console.error('\n\x1b[31mBuild validation FAILED.\x1b[0m');
  console.error('Remove the scripts writing these files from postbuild in package.json.');
  process.exit(1);
} else {
  console.log('\x1b[32mSitemap validation passed — no SSR endpoint conflicts.\x1b[0m');
}
